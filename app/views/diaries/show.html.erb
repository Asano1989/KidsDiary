<div id="diary_show" class="text-center">
  <h1 class="text-3xl font-bold m-6">日記の詳細</h1>

  <div id="diary_detail">
    <table class="mx-auto border-collapse border">
      <tbody>
        <tr>
          <th class="border-collapse border p-2">id</th>
          <td class="border-collapse border p-2"><%= @diary.id %></td>
        </tr>
        <tr>
          <th class="border-collapse border p-2">date</th>
          <td class="border-collapse border p-2"><%= @diary.date %></td>
        </tr>
        <tr>
          <th class="border-collapse border p-2">user's<br/>family_id</th>
          <td class="border-collapse border p-2"><%= @diary.user.family_id %></td>
        </tr>
        <tr>
          <th class="border-collapse border p-2">user's<br/>family</th>
          <td class="border-collapse border p-2"><%= @diary.user.family.name %></td>
        </tr>
        <tr>
          <th class="border-collapse border p-2">user</th>
          <td class="border-collapse border p-2"><%= @diary.user.name %></td>
        </tr>
        <tr>
          <th class="border-collapse border p-2">children</th>
          <td class="border-collapse border p-2">
            <% @diary.children.each do |child| %>
              <%
                current_ids = Array.wrap(params[:child_ids]).map(&:to_s)
                
                if current_ids.include?(child.id.to_s)
                  # すでに選択済みなら、そのIDを取り除く（解除リンクになる）
                  next_ids = current_ids - [child.id.to_s]
                else
                  # 未選択なら、IDを追加する
                  next_ids = current_ids + [child.id.to_s]
                end
              %>
                <%= link_to child.name, filter_diaries_path(child_ids: next_ids, emoji_id: params[:emoji_id]), data: { turbo: false } %><br/>
            <% end %>
          </td>
        </tr>
        <tr>
          <th class="border-collapse border p-2">emoji's id</th>
          <td class="border-collapse border p-2">
              <%= @diary.emoji.id %>
          </td>
        </tr>
        <tr>
          <th class="border-collapse border p-2">emoji</th>
          <td class="border-collapse border p-2">
            <%= link_to filter_diaries_path(child_ids: params[:child_ids], emoji_id: @diary.emoji.id), data: { turbo: false } do %>
              <%= @diary.emoji.character %>
            <% end %>
          </td>
        </tr>
        <tr>
          <th class="border-collapse border p-2">body</th>
          <td class="border-collapse border p-2"><%= @diary.body %></td>
        </tr>
        <% if current_user.id == @diary.user_id %>
        <tr>
          <td colspan="2">
            <div class="flex p-2">
              <div class="flex-auto">
                <%= button_to "編集", edit_diary_path(diary_id: @diary.id), method: :get, data: { turbo: false }, class: "box-border border border-default-medium shadow-xs font-medium leading-5 rounded-full text-sm px-4 py-2 m-2" %>
              </div>
              <div class="flex-auto">
                <%= button_to "削除", diary_path(@diary.id), method: :delete, data: { turbo_method: :delete, turbo_confirm: '本当にこの日記を削除しますか？' }, class: "box-border border border-default-medium shadow-xs font-medium leading-5 rounded-full text-sm px-4 py-2 m-2" %>
              </div>
          </td>
        </tr>
        <% end %>
        <tr>
          <td colspan="2"  class="border-collapse border p-2">
            <div class="flex flex-wrap gap-2 mt-4">
              <%# 1. 既に付いているリアクションをカウントして表示 %>
              <% @diary.reactions.group(:emoji_id).count.each do |emoji_id, count| %>
                <% emoji = Emoji.find(emoji_id) %>
                <button class="flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-gray-200 border rounded-full transition">
                  <span><%= emoji.character %></span>
                  <span class="text-xs font-bold text-gray-600"><%= count %></span>
                </button>
              <% end %>

              <%# 2. 新しくリアクションを追加するためのボタン（＋マークなど） %>
              <details class="relative inline-block overflow-visible">
                <summary class="list-none cursor-pointer">
                  <div class="px-3 py-1 border-2 border-dashed border-gray-300 rounded-full text-gray-400">
                    ＋
                  </div>
                </summary>

                <%# クリックするとこれが表示される %>
                <div class="absolute bottom-full left-0 mb-2 flex bg-white border shadow-xl rounded-lg p-2 gap-2 z-50 min-w-max">
                  <% Emoji.order("RANDOM()").limit(6).each do |emoji| %>
                    <%= button_to diary_reactions_path(@diary, emoji_id: emoji.id),
                                  method: :post,
                                  class: "text-xl hover:scale-125 transition" do %>
                      <%= emoji.character %>
                    <% end %>
                  <% end %>
                </div>
              </details>

              <style>
                /* 三角矢印を消すためのスタイル */
                summary::-webkit-details-marker { display: none; }
              </style>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>